<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Checkout - Confirma√ß√£o do Pedido</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
            padding: 16px;
            color: #1f2937;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .header p {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .main-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 10px 13px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
        }

        .card-header {
            padding: 14px 16px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .card-header.blue {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .card-header.green {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .card-header.purple {
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
        }

        .card-content {
            padding: 16px;
        }

        /* Bloco Produtos + Resumo */
        .products-summary-block {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 10px 13px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .products-section {
            padding: 16px;
            border-bottom: 2px solid #f3f4f6;
        }

        .products-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
        }

        .empty-cart {
            text-align: center;
            padding: 32px 16px;
            color: #9ca3af;
            font-style: italic;
            font-size: 0.95rem;
        }

        .cart-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            border-radius: 8px;
            background: #f3f4f6;
            padding: 6px;
            flex-shrink: 0;
        }

        .cart-item-info {
            flex: 1;
            min-width: 0;
        }

        .cart-item-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .cart-item-model {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .cart-item-qty {
            font-size: 0.8rem;
            color: #4b5563;
        }

        .cart-item-price {
            text-align: right;
            flex-shrink: 0;
        }

        .cart-item-subtotal {
            font-weight: 700;
            color: #2563eb;
            font-size: 1rem;
        }

        .cart-item-unit {
            font-size: 0.7rem;
            color: #9ca3af;
            margin-top: 2px;
        }

        /* Resumo Section */
        .summary-section {
            padding: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .summary-row span:first-child {
            color: #6b7280;
        }

        .summary-row span:last-child {
            font-weight: 600;
            color: #111827;
        }

        .summary-divider {
            border-top: 2px solid #e2e8f0;
            padding-top: 12px;
            margin-top: 12px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .summary-total span:first-child {
            color: #111827;
        }

        .summary-total span:last-child {
            color: #2563eb;
        }

        /* Payment Option */
        .payment-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            min-height: 60px;
            margin-bottom: 12px; /* Adicionado para espa√ßamento entre as op√ß√µes */
        }

        .payment-option:last-child {
            margin-bottom: 0;
        }

        .payment-option.selected {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .payment-option:active {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .payment-option input[type="radio"] {
            margin-top: 4px;
            cursor: pointer;
            width: 20px;
            height: 20px;
            min-width: 20px;
            accent-color: #2563eb;
        }

        .payment-option-text {
            flex: 1;
        }

        .payment-option-text h3 {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .payment-option-text p {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group input:disabled {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        .form-group-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .cep-input-group {
            display: flex;
            gap: 8px;
        }

        .cep-input-group input {
            flex: 1;
        }

        .cep-input-group button {
            padding: 14px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
            flex-shrink: 0;
            -webkit-appearance: none;
            appearance: none;
            min-height: 48px;
        }

        .cep-input-group button:active:not(:disabled) {
            background: #1d4ed8;
            transform: scale(0.98);
        }

        .cep-input-group button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .cep-input-group button.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            font-size: 0.9rem;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-icon {
            flex-shrink: 0;
            margin-top: 2px;
            font-size: 1.2rem;
        }

        .address-fields {
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
            margin-top: 16px;
        }

        /* Novo estilo para o bot√£o Prosseguir/Finalizar */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
            -webkit-appearance: none;
            appearance: none;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary:active:not(:disabled) {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .summary-note {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
            margin-top: 10px;
            line-height: 1.4;
        }

        /* Estilos para a nova tela de resumo */
        .checkout-step {
            display: none;
        }

        .checkout-step.active {
            display: block;
        }

        .summary-details {
            padding: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 10px 13px rgba(0, 0, 0, 0.1);
            margin-bottom: 16px;
        }

        .summary-details h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-details p {
            font-size: 0.9rem;
            color: #4b5563;
            margin-bottom: 8px;
        }

        .summary-details strong {
            color: #111827;
        }

        .summary-details .total-final {
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 2px solid #059669;
            display: flex;
            justify-content: space-between;
        }

        /* Responsive */
        @media (max-width: 640px) {
            body {
                padding: 12px;
                padding-bottom: 24px;
            }

            .header {
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .main-grid {
                gap: 12px;
            }

            .card-content {
                padding: 14px;
            }

            .products-section {
                padding: 14px;
            }

            .summary-section {
                padding: 14px;
            }

            .form-group {
                margin-bottom: 14px;
            }

            .form-group-row {
                gap: 10px;
            }

            .cart-item {
                gap: 10px;
                padding: 10px 0;
            }

            .cart-item-img {
                width: 60px;
                height: 60px;
            }

            .payment-option {
                min-height: 56px;
            }

            .summary-row {
                margin-bottom: 8px;
                font-size: 0.85rem;
            }

            .summary-total {
                font-size: 1rem;
            }
        }

        @media (max-height: 600px) and (orientation: landscape) {
            body {
                padding: 8px;
            }

            .header h1 {
                font-size: 1.3rem;
                margin-bottom: 4px;
            }

            .card-content {
                padding: 12px;
            }

            .form-group {
                margin-bottom: 10px;
            }
        }

        input {
            font-size: 16px !important;
        }

        @supports (padding: max(0px)) {
            body {
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Passo 1: Confirma√ß√£o do Pedido e Endere√ßo -->
        <div id="step-1" class="checkout-step active">
            <!-- Header -->
            <div class="header">
                <h1>Confirma√ß√£o do Pedido</h1>
                <p>Revise seus itens e complete o endere√ßo</p>
            </div>

            <!-- Main Grid -->
            <div class="main-grid">
                <!-- Produtos + Resumo Unified Block -->
                <div class="products-summary-block">
                    <!-- Produtos Section -->
                    <div class="products-section">
                        <div class="products-header">
                            <span>üì¶</span> Produtos
                        </div>
                        <div id="cart-items-container">
                            <div class="empty-cart">Seu carrinho est√° vazio</div>
                        </div>
                    </div>

                    <!-- Resumo Section -->
                    <div class="summary-section">
                        <div class="summary-header">
                            <span>üìä</span> Resumo
                        </div>
                        <div class="summary-row">
                            <span>Subtotal (Produtos)</span>
                            <span id="subtotal">R$ 0,00</span>
                        </div>
                        <div class="summary-row">
                            <span>Complemento (Envio/Instala√ß√£o)</span>
                            <span id="complemento-valor">R$ 0,00</span>
                        </div>
                        <div class="summary-divider">
                            <div class="summary-total">
                                <span>Total a Pagar Agora</span>
                                <span id="total-agora">R$ 0,00</span>
                            </div>
                        </div>
                        <p class="summary-note" style="text-align: right; margin-top: 5px;">
                            *O valor dos produtos ser√° pago apenas na entrega.
                        </p>
                    </div>
                </div>

                <!-- M√©todo de Pagamento Card -->
                <div class="card">
                    <div class="card-header green">
                        <span>üí≥</span> M√©todo de Pagamento
                    </div>
                    <div class="card-content">
                        <label class="payment-option selected" id="payment-option-cash">
                            <input type="radio" name="payment" value="cash" checked>
                            <div class="payment-option-text">
                                <h3>Pagamento ap√≥s a entrega</h3>
                                <p>O valor dos produtos ser√° pago somente quando voc√™ receber.</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Op√ß√µes de Envio Card -->
                <div class="card">
                    <div class="card-header purple">
                        <span>üìç</span> Op√ß√µes de Envio
                    </div>
                    <div class="card-content">
                        <!-- CEP Input -->
                        <div class="form-group">
                            <label for="cep">CEP</label>
                            <div class="cep-input-group">
                                <input 
                                    type="text" 
                                    id="cep" 
                                    placeholder="00000-000" 
                                    maxlength="9"
                                    inputmode="numeric"
                                >
                                <button id="btn-search-cep">Buscar</button>
                            </div>
                        </div>

                        <!-- Error Alert -->
                        <div id="cep-error" class="alert error" style="display: none;">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <span id="error-message"></span>
                        </div>

                        <!-- Address Fields -->
                        <div id="address-fields" class="address-fields" style="display: none;">
                            <div class="form-group-row">
                                <div class="form-group">
                                    <label for="logradouro">Logradouro</label>
                                    <input type="text" id="logradouro" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="bairro">Bairro</label>
                                    <input type="text" id="bairro" disabled>
                                </div>
                            </div>

                            <div class="form-group-row">
                                <div class="form-group">
                                    <label for="uf">Estado (UF)</label>
                                    <input type="text" id="uf" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="numero">N√∫mero *</label>
                                    <input type="text" id="numero" placeholder="Ex: 123" inputmode="numeric">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="complemento">Complemento</label>
                                <input type="text" id="complemento" placeholder="Ex: Apto 101">
                            </div>

                            <!-- NOVAS OP√á√ïES DE COMPLEMENTO/ENVIO -->
                            <div class="form-group" id="complemento-options-container">
                                <label>Complemento (Envio)</label>
                                <label class="payment-option" data-valor="35.90" data-link="LINK_ENVIO_35_90">
                                    <input type="radio" name="complemento-option" value="envio" checked>
                                    <div class="payment-option-text">
                                        <h3>Envio - Receba Amanh√£</h3>
                                        <p>Custo: R$ 35,90</p>
                                    </div>
                                </label>
                                <label class="payment-option" data-valor="43.90" data-link="LINK_ENVIO_INSTALACAO_43_90">
                                    <input type="radio" name="complemento-option" value="envio-instalacao">
                                    <div class="payment-option-text">
                                        <h3>Envio + Instala√ß√£o - Receba Amanh√£</h3>
                                        <p>Custo: R$ 43,90</p>
                                    </div>
                                </label>
                            </div>
                            <!-- FIM NOVAS OP√á√ïES DE COMPLEMENTO/ENVIO -->
                        </div>
                    </div>
                </div>

                <!-- Bot√£o Prosseguir -->
                <button id="btn-prosseguir" class="btn-primary" disabled>
                    Prosseguir
                </button>
                <p class="summary-note">
                    Ao prosseguir, voc√™ ser√° levado para a tela de resumo e pagamento do complemento.
                </p>
            </div>
        </div>

        <!-- Passo 2: Resumo e Finaliza√ß√£o -->
        <div id="step-2" class="checkout-step">
            <div class="header">
                <h1>Resumo do Pedido</h1>
                <p>Confirme os detalhes e finalize o pagamento do complemento.</p>
            </div>

            <div class="main-grid">
                <!-- Detalhes do Pedido -->
                <div class="summary-details">
                    <h2>Itens do Pedido</h2>
                    <div id="summary-products-list"></div>
                </div>

                <!-- Detalhes do Endere√ßo -->
                <div class="summary-details">
                    <h2>Endere√ßo de Entrega</h2>
                    <p><strong>CEP:</strong> <span id="summary-cep"></span></p>
                    <p><strong>Endere√ßo:</strong> <span id="summary-address"></span></p>
                    <p><strong>Bairro:</strong> <span id="summary-bairro"></span></p>
                    <p><strong>Estado:</strong> <span id="summary-uf"></span></p>
                    <p><strong>Complemento:</strong> <span id="summary-complemento-text"></span></p>
                </div>

                <!-- Detalhes do Complemento -->
                <div class="summary-details">
                    <h2>Complemento Selecionado</h2>
                    <p><strong>Op√ß√£o:</strong> <span id="summary-complemento-option"></span></p>
                    <div class="total-final">
                        <span>Total a Pagar Agora:</span>
                        <span id="summary-total-agora">R$ 0,00</span>
                    </div>
                    <p class="summary-note" style="text-align: left; margin-top: 10px;">
                        *O valor dos produtos (<span id="summary-subtotal-produtos">R$ 0,00</span>) ser√° pago apenas na entrega.
                    </p>
                </div>

                <!-- Bot√£o Finalizar -->
                <button id="btn-finalizar" class="btn-primary">
                    Finalizar (Pagar <span id="btn-finalizar-valor">R$ 0,00</span>)
                </button>
                <p class="summary-note">
                    Voc√™ ser√° redirecionado para o link de pagamento do complemento.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Cat√°logo de Pe√ßas
        const catalogoPecas = [
            { id: 101, nome: "Moura M50ED - 50Ah", preco: 349.90, modelo: "Automotiva", estoque: 50, imagem_url: "https://cdn.shopify.com/s/files/1/0771/3115/3652/files/17303139164879-moura_pack_frontal_a-684b0da176fa5_1.png?v=1762392888" },
            { id: 102, nome: "Moura M60AD - 60Ah", preco: 499.90, modelo: "Automotiva", estoque: 50, imagem_url: "https://cdn.shopify.com/s/files/1/0771/3115/3652/files/17303139164879-moura_pack_frontal_a-684b0da176fa5_1.png?v=1762392888" },
            { id: 103, nome: "Moura M70AE - 70Ah", preco: 619.90, modelo: "Automotiva", estoque: 32, imagem_url: "https://cdn.shopify.com/s/files/1/0771/3115/3652/files/17303139164879-moura_pack_frontal_a-684b0da176fa5_1.png?v=1762392888" },
            { id: 104, nome: "Moura Moto MA5-D - 5Ah", preco: 189.90, modelo: "Moto", estoque: 21, imagem_url: "https://cdn.shopify.com/s/files/1/0771/3115/3652/files/17303139164879-moura_pack_frontal_a-684b0da176fa5_1.png?v=1762392888" },
            { id: 105, nome: "Moura Moto MA9-E - 9Ah", preco: 279.90, modelo: "Moto", estoque: 21, imagem_url: "https://i.imgur.com/M7q1z0Z.png" },
            { id: 106, nome: "Moura Estacion√°ria Clean 100Ah", preco: 1250.00, modelo: "Estacion√°ria", estoque: 21, imagem_url: "https://i.imgur.com/M7q1z0Z.png" },
        ];

        // Dados das op√ß√µes de complemento (Envio/Instala√ß√£o)
        const complementoOptions = {
            'envio': {
                valor: 35.90,
                descricao: 'Envio - Receba Amanh√£',
                linkPagamento: 'LINK_ENVIO_35_90' // Placeholder
            },
            'envio-instalacao': {
                valor: 43.90,
                descricao: 'Envio + Instala√ß√£o - Receba Amanh√£',
                linkPagamento: 'LINK_ENVIO_INSTALACAO_43_90' // Placeholder
            }
        };

        // Estado Global
        let carrinho = [];
        let endereco = {
            cep: '',
            logradouro: '',
            bairro: '',
            uf: '',
            numero: '',
            complemento: ''
        };
        let complementoSelecionado = 'envio'; // Padr√£o

        // DOM Elements - Step 1
        const step1 = document.getElementById('step-1');
        const cepInput = document.getElementById('cep');
        const btnSearchCep = document.getElementById('btn-search-cep');
        const cepError = document.getElementById('cep-error');
        const errorMessage = document.getElementById('error-message');
        const addressFields = document.getElementById('address-fields');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const subtotalEl = document.getElementById('subtotal');
        const complementoValorEl = document.getElementById('complemento-valor');
        const totalAgoraEl = document.getElementById('total-agora');
        const btnProsseguir = document.getElementById('btn-prosseguir');
        const complementoOptionsContainer = document.getElementById('complemento-options-container');

        // DOM Elements - Step 2
        const step2 = document.getElementById('step-2');
        const summaryProductsList = document.getElementById('summary-products-list');
        const summaryCep = document.getElementById('summary-cep');
        const summaryAddress = document.getElementById('summary-address');
        const summaryBairro = document.getElementById('summary-bairro');
        const summaryUf = document.getElementById('summary-uf');
        const summaryComplementoText = document.getElementById('summary-complemento-text');
        const summaryComplementoOption = document.getElementById('summary-complemento-option');
        const summaryTotalAgora = document.getElementById('summary-total-agora');
        const summarySubtotalProdutos = document.getElementById('summary-subtotal-produtos');
        const btnFinalizar = document.getElementById('btn-finalizar');
        const btnFinalizarValor = document.getElementById('btn-finalizar-valor');

        // Fun√ß√µes de Formata√ß√£o
        const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;

        // L√≥gica de Sele√ß√£o de Complemento
        document.querySelectorAll('#complemento-options-container .payment-option').forEach(label => {
            label.addEventListener('click', () => {
                const radio = label.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    // Disparar o evento 'change' manualmente para garantir que a l√≥gica de sele√ß√£o seja executada
                    const changeEvent = new Event('change', { bubbles: true });
                    radio.dispatchEvent(changeEvent);
                }
            });
        });

        complementoOptionsContainer.addEventListener('change', (e) => {
            if (e.target.name === 'complemento-option') {
                complementoSelecionado = e.target.value;
                document.querySelectorAll('#complemento-options-container .payment-option').forEach(label => {
                    label.classList.remove('selected');
                });
                e.target.closest('.payment-option').classList.add('selected');
                atualizarTotais();
            }
        });

        // Formatar CEP
        cepInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            if (value.length > 5) {
                value = value.slice(0, 5) + '-' + value.slice(5);
            }
            e.target.value = value;
            endereco.cep = value;
            validarFormulario();
        });

        // Buscar CEP
        btnSearchCep.addEventListener('click', buscarCep);
        cepInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Previne o envio do formul√°rio
                buscarCep();
            }
        });

        async function buscarCep() {
            const cepLimpo = cepInput.value.replace(/\D/g, '');

            if (cepLimpo.length !== 8) {
                mostrarErro('CEP deve conter 8 d√≠gitos');
                return;
            }

            btnSearchCep.disabled = true;
            btnSearchCep.classList.add('loading');
            btnSearchCep.innerHTML = '<span class="spinner"></span>';
            cepError.style.display = 'none';

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
                const data = await response.json();

                if (data.erro) {
                    mostrarErro('CEP n√£o encontrado');
                    return;
                }

                endereco = {
                    cep: cepInput.value,
                    logradouro: data.logradouro || '',
                    bairro: data.bairro || '',
                    uf: data.uf || '',
                    numero: document.getElementById('numero').value, // Mant√©m o n√∫mero se j√° digitado
                    complemento: document.getElementById('complemento').value // Mant√©m o complemento se j√° digitado
                };

                preencherEndereco();
                addressFields.style.display = 'block';
                cepError.style.display = 'none';
                
                // Scroll para campos de endere√ßo
                setTimeout(() => {
                    document.getElementById('numero').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            } catch (error) {
                mostrarErro('Erro ao buscar CEP. Tente novamente.');
                console.error('Erro:', error);
            } finally {
                btnSearchCep.disabled = false;
                btnSearchCep.classList.remove('loading');
                btnSearchCep.textContent = 'Buscar';
                validarFormulario();
            }
        }

        function mostrarErro(mensagem) {
            errorMessage.textContent = mensagem;
            cepError.style.display = 'flex';
            addressFields.style.display = 'none';
            btnSearchCep.disabled = false;
            btnSearchCep.classList.remove('loading');
            btnSearchCep.textContent = 'Buscar';
            validarFormulario();
        }

        function preencherEndereco() {
            document.getElementById('logradouro').value = endereco.logradouro;
            document.getElementById('bairro').value = endereco.bairro;
            document.getElementById('uf').value = endereco.uf;
        }

        // Atualizar endere√ßo ao digitar
        document.getElementById('numero').addEventListener('input', (e) => {
            endereco.numero = e.target.value;
            validarFormulario();
        });

        document.getElementById('complemento').addEventListener('input', (e) => {
            endereco.complemento = e.target.value;
            validarFormulario();
        });

        // Valida√ß√£o do Formul√°rio
        function validarFormulario() {
            const numeroValido = endereco.numero.trim() !== '';
            const cepValido = endereco.cep.replace(/\D/g, '').length === 8;
            const enderecoCompleto = endereco.logradouro.trim() !== '' && endereco.bairro.trim() !== '' && endereco.uf.trim() !== '';
            const carrinhoNaoVazio = carrinho.length > 0;

            const formValido = cepValido && enderecoCompleto && numeroValido && carrinhoNaoVazio;
            btnProsseguir.disabled = !formValido;
        }

        // Deserializar carrinho da URL
        function deserializarCarrinho() {
            const urlParams = new URLSearchParams(window.location.search);
            const carrinhoSerializado = urlParams.get('carrinho');

            if (!carrinhoSerializado) {
                return;
            }

            try {
                const jsonString = atob(carrinhoSerializado);
                const itensSimples = JSON.parse(jsonString);

                carrinho = itensSimples
                    .map(itemSimples => {
                        const produtoCompleto = catalogoPecas.find(p => p.id === itemSimples.id);
                        if (produtoCompleto) {
                            return {
                                id: produtoCompleto.id,
                                nome: produtoCompleto.nome,
                                preco: produtoCompleto.preco,
                                quantidade: itemSimples.q,
                                modelo: produtoCompleto.modelo,
                                imagem_url: produtoCompleto.imagem_url
                            };
                        }
                        return null;
                    })
                    .filter(item => item !== null);

                renderizarCarrinho();
            } catch (e) {
                console.error('Erro ao deserializar carrinho:', e);
            }
        }

        // Renderizar carrinho
        function renderizarCarrinho() {
            if (carrinho.length === 0) {
                cartItemsContainer.innerHTML = '<div class="empty-cart">Seu carrinho est√° vazio</div>';
                validarFormulario();
                return;
            }

            cartItemsContainer.innerHTML = '';
            let totalProdutos = 0;

            carrinho.forEach(item => {
                const subtotal = item.preco * item.quantidade;
                totalProdutos += subtotal;

                const itemEl = document.createElement('div');
                itemEl.className = 'cart-item';
                itemEl.innerHTML = `
                    <img src="${item.imagem_url}" alt="${item.nome}" class="cart-item-img">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.nome}</div>
                        <div class="cart-item-model">${item.modelo}</div>
                        <div class="cart-item-qty">Qtde: ${item.quantidade}x</div>
                    </div>
                    <div class="cart-item-price">
                        <div class="cart-item-subtotal">${formatCurrency(subtotal)}</div>
                        <div class="cart-item-unit">${formatCurrency(item.preco)} un.</div>
                    </div>
                `;
                cartItemsContainer.appendChild(itemEl);
            });

            atualizarTotais(totalProdutos);
            validarFormulario();
        }

        // Calcular total de produtos
        function calcularTotalProdutos() {
            return carrinho.reduce((total, item) => total + item.preco * item.quantidade, 0);
        }

        // Atualizar totais
        function atualizarTotais(totalProdutos = calcularTotalProdutos()) {
            const valorComplemento = complementoOptions[complementoSelecionado].valor;
            const totalAgora = valorComplemento;

            subtotalEl.textContent = formatCurrency(totalProdutos);
            complementoValorEl.textContent = formatCurrency(valorComplemento);
            totalAgoraEl.textContent = formatCurrency(totalAgora);

            // Atualiza o bot√£o Prosseguir/Finalizar
            btnFinalizarValor.textContent = formatCurrency(totalAgora);
        }

        // L√≥gica de Transi√ß√£o de Passo
        btnProsseguir.addEventListener('click', () => {
            if (btnProsseguir.disabled) return;

            // 1. Preencher Resumo
            const totalProdutos = calcularTotalProdutos();
            const complementoData = complementoOptions[complementoSelecionado];
            const totalAgora = complementoData.valor;

            // Produtos
            summaryProductsList.innerHTML = carrinho.map(item => {
                const subtotal = item.preco * item.quantidade;
                return `<p>${item.quantidade}x <strong>${item.nome}</strong> (${item.modelo}) - ${formatCurrency(subtotal)}</p>`;
            }).join('');

            // Endere√ßo
            summaryCep.textContent = endereco.cep;
            summaryAddress.textContent = `${endereco.logradouro}, ${endereco.numero}`;
            summaryBairro.textContent = endereco.bairro;
            summaryUf.textContent = endereco.uf;
            summaryComplementoText.textContent = endereco.complemento || 'N/A';

            // Totais
            summaryComplementoOption.textContent = `${complementoData.descricao} (${formatCurrency(complementoData.valor)})`;
            summaryTotalAgora.textContent = formatCurrency(totalAgora);
            summarySubtotalProdutos.textContent = formatCurrency(totalProdutos);
            btnFinalizarValor.textContent = formatCurrency(totalAgora);

            // 2. Transi√ß√£o de Tela
            step1.classList.remove('active');
            step2.classList.add('active');
            window.scrollTo(0, 0); // Volta para o topo
        });

        // L√≥gica de Finaliza√ß√£o (Redirecionamento)
        btnFinalizar.addEventListener('click', () => {
            const linkPagamento = complementoOptions[complementoSelecionado].linkPagamento;
            
            // AQUI VOC√ä DEVE INSERIR A L√ìGICA PARA REDIRECIONAR PARA O LINK DE PAGAMENTO
            // O link de pagamento deve ser configurado no objeto `complementoOptions`
            if (linkPagamento && linkPagamento.startsWith('http')) {
                window.location.href = linkPagamento;
            } else {
                alert(`Redirecionamento para pagamento n√£o configurado. Link placeholder: ${linkPagamento}`);
                console.error('Link de pagamento n√£o configurado para a op√ß√£o:', complementoSelecionado);
            }
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            deserializarCarrinho();
            // Garante que a op√ß√£o de complemento padr√£o esteja visualmente selecionada
            document.querySelector(`label[data-valor="35.90"]`).classList.add('selected');
        });
    </script>
</body>
</html>
